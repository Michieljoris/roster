<!DOCTYPE html><html><head><title>shiftQualifier.js</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../index.html" class="source"><span class="file_name">README</span></a><a href="../js/layout.js.html" class="source "><span class="base_path">js / </span><span class="file_name">layout.js</span></a><a href="../js/calculateTimesheet.js.html" class="source "><span class="base_path">js / </span><span class="file_name">calculateTimesheet.js</span></a><a href="../js/main.js.html" class="source "><span class="base_path">js / </span><span class="file_name">main.js</span></a><a href="../js/globals.js.html" class="source "><span class="base_path">js / </span><span class="file_name">globals.js</span></a><a href="../js/old/liveorig.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">liveorig.js</span></a><a href="../js/old/dataclasses.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">dataclasses.js</span></a><a href="../js/old/data-structures.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">data-structures.js</span></a><a href="../js/old/viewtree.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">viewtree.js</span></a><a href="../js/old/testsc.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">testsc.js</span></a><a href="../js/old/nodejuice.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">nodejuice.js</span></a><a href="../js/old/utils.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">utils.js</span></a><a href="../js/old/smartclientui.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">smartclientui.js</span></a><a href="../js/old/data-structures.coffee.html" class="source "><span class="base_path">js / old / </span><span class="file_name">data-structures.coffee</span></a><a href="../js/old/testpouch.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">testpouch.js</span></a><a href="../js/old/roster.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">roster.js</span></a><a href="../js/old/datasources.js.html" class="source "><span class="base_path">js / old / </span><span class="file_name">datasources.js</span></a><a href="../js/table.js.html" class="source "><span class="base_path">js / </span><span class="file_name">table.js</span></a><a href="../js/typesAndFields.js.html" class="source "><span class="base_path">js / </span><span class="file_name">typesAndFields.js</span></a><a href="../js/shiftEditor.js.html" class="source "><span class="base_path">js / </span><span class="file_name">shiftEditor.js</span></a><a href="../js/fetchTimesheetShifts.js.html" class="source "><span class="base_path">js / </span><span class="file_name">fetchTimesheetShifts.js</span></a><a href="../js/timesheet_canvas.js.html" class="source "><span class="base_path">js / </span><span class="file_name">timesheet_canvas.js</span></a><a href="../js/shift.js.html" class="source "><span class="base_path">js / </span><span class="file_name">shift.js</span></a><a href="../js/personEditor.js.html" class="source "><span class="base_path">js / </span><span class="file_name">personEditor.js</span></a><a href="../js/editorManager.js.html" class="source "><span class="base_path">js / </span><span class="file_name">editorManager.js</span></a><a href="../js/editorUtils.js.html" class="source "><span class="base_path">js / </span><span class="file_name">editorUtils.js</span></a><a href="../js/parentListEditor.js.html" class="source "><span class="base_path">js / </span><span class="file_name">parentListEditor.js</span></a><a href="../js/testdata.js.html" class="source "><span class="base_path">js / </span><span class="file_name">testdata.js</span></a><a href="../js/pouchDS.js.html" class="source "><span class="base_path">js / </span><span class="file_name">pouchDS.js</span></a><a href="../js/viewTree.js.html" class="source "><span class="base_path">js / </span><span class="file_name">viewTree.js</span></a><a href="../js/quickpouch.js.html" class="source "><span class="base_path">js / </span><span class="file_name">quickpouch.js</span></a><a href="../js/editorLoader.js.html" class="source "><span class="base_path">js / </span><span class="file_name">editorLoader.js</span></a><a href="../js/timesheet.js.html" class="source "><span class="base_path">js / </span><span class="file_name">timesheet.js</span></a><a href="../js/calendar.js.html" class="source "><span class="base_path">js / </span><span class="file_name">calendar.js</span></a><a href="../js/locationEditor.js.html" class="source "><span class="base_path">js / </span><span class="file_name">locationEditor.js</span></a><a href="../js/shiftQualifier.js.html" class="source selected"><span class="base_path">js / </span><span class="file_name">shiftQualifier.js</span></a><a href="../js/test.js.html" class="source "><span class="base_path">js / </span><span class="file_name">test.js</span></a><a href="../js/calculateTimesheetColumn.js.html" class="source "><span class="base_path">js / </span><span class="file_name">calculateTimesheetColumn.js</span></a><a href="../js/tableFilter.js.html" class="source "><span class="base_path">js / </span><span class="file_name">tableFilter.js</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>shiftQualifier.js</h1><div class="filepath">js/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div><div class="dox"><div class="summary"><p>lobal define: false logger:false</p></div><div class="body"></div></div><div class="dox"><div class="summary"><p>shint strict:false unused:true smarttabs:true eqeqeq:true immed: true undef:true</p></div><div class="body"></div></div><div class="dox"><div class="summary"><p>shint maxparams:5 maxcomplexity:100 maxlen:190 devel:true</p></div><div class="body"></div></div>
</td><td class="code"><div class="highlight"><pre><span class="nx">define</span>
<span class="p">({</span> 
    <span class="nx">inject</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;lib/utils&#39;</span><span class="p">],</span>
    <span class="nx">factory</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">utils</span><span class="p">)</span>
    <span class="p">{</span> <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">logger</span><span class="p">(</span><span class="s1">&#39;timeQualifier&#39;</span><span class="p">);</span></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>logger.showStamp();
logger.setLevel('info');</p>
</td><td class="code"><div class="highlight"><pre>      
      <span class="kd">var</span> <span class="nx">patternsArray</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Describe a repeat pattern by setting date to an arbitrary
(long ago) date, and to a day of the week of your choosing,
and to the start time of the period that repeats. Length is
the length of the period in hours The pattern is an array of
lengths of units, describing when the period will
reoccur. Higher ranks take prevalence over lower ranks. 
Pattern with no rank property will always be applied</p>
</td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">defaultPatternsObject</span> <span class="o">=</span> <span class="p">{</span> </pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><p>night1: { type: 'night', 
          from: Date.parse('2000 10pm').monday(),'2000', '10pm', 'monday'
          to: Date.parse('2000 10pm').monday(), //undefined is indefinitely
          length: 2, //in hours
          pattern: [1], //repeate daily 
          unit: 'day'
          // rank: 100
        },</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">day</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> 
                    <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2000 6am&#39;</span><span class="p">).</span><span class="nx">monday</span><span class="p">(),</span>
                    <span class="nx">length</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span> <span class="c1">//in hours</span>
                    <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1">//repeated daily </span>
                    <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>rank: 100</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="p">},</span>
          <span class="nx">night1</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;night&#39;</span><span class="p">,</span> 
                    <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2000 10pm&#39;</span><span class="p">).</span><span class="nx">monday</span><span class="p">(),</span>
                    <span class="nx">to</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2014 10pm&#39;</span><span class="p">).</span><span class="nx">monday</span><span class="p">(),</span> <span class="c1">//undefined is indefinitely TODO, not implemented</span>
                    <span class="nx">length</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="c1">//in hours</span>
                    <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="c1">//repeated daily </span>
                    <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>rank: 100</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="p">},</span>
          <span class="nx">night2</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;night&#39;</span><span class="p">,</span>
                    <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2000 0am&#39;</span><span class="p">).</span><span class="nx">monday</span><span class="p">(),</span>
                    <span class="nx">length</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
                    <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>rank: 100</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="p">},</span>
          <span class="nx">early</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;early&#39;</span><span class="p">,</span>
                   <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2000 6am&#39;</span><span class="p">).</span><span class="nx">monday</span><span class="p">(),</span>
                   <span class="nx">length</span><span class="o">:</span> <span class="mf">1.5</span><span class="p">,</span>
                   <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                   <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span>
                   <span class="nx">rank</span><span class="o">:</span> <span class="mi">100</span>
                 <span class="p">},</span>
          <span class="nx">ord</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;ord&#39;</span><span class="p">,</span>
                 <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2000 7:30am&#39;</span><span class="p">).</span><span class="nx">monday</span><span class="p">(),</span>
                 <span class="nx">length</span><span class="o">:</span> <span class="mi">12</span><span class="p">,</span>
                 <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                 <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span>
                 <span class="nx">rank</span><span class="o">:</span> <span class="mi">100</span>
               <span class="p">},</span>
          <span class="nx">late</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;late&#39;</span><span class="p">,</span>
                  <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2000 7:30pm&#39;</span><span class="p">).</span><span class="nx">monday</span><span class="p">(),</span>
                  <span class="nx">length</span><span class="o">:</span> <span class="mf">2.5</span><span class="p">,</span>
                  <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">],</span>
                  <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span>
                  <span class="nx">rank</span><span class="o">:</span> <span class="mi">100</span>
                <span class="p">},</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>3 ways to describe weekends:
this one finds both days in one pattern though:</p>
</td><td class="code"><div class="highlight"><pre>          <span class="nx">weekend</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;weekend&#39;</span><span class="p">,</span>
                     <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;2000 6:00am&#39;</span><span class="p">).</span><span class="nx">saturday</span><span class="p">(),</span>
                     <span class="nx">length</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
                     <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
                     <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span>
                     <span class="nx">rank</span><span class="o">:</span> <span class="mi">200</span>
                   <span class="p">},</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>night3: { type: 'night', 
          date: Date.parse('2000 10pm').monday(),
          length: 2, //in hours
          pattern: [1], //repeate daily 
          unit: 'day',
          rank: 200
        },
night4: { type: 'night',
          date: Date.parse('2000 0am').monday(),
          length: 6,
          pattern: [1],
          unit: 'day',
          rank: 200
        },
and:
weekend2: { type: 'weekend',
  date: Date.parse('2000 0:00am').saturday(),
  length: 24,
  pattern: [1],
  unit: 'week',
  rank: 200
},
weekend3: { type: 'weekend',
  date: Date.parse('2000 0:00am').sunday(),
  length: 24,
  pattern: [1],
  unit: 'week',
  rank: 200
},
and: //this would have to be split into two patterns:
weekend4:{ type: 'weekend',
  date: Date.parse('2000 0:00am').saturday(),
  length: 48, //48 hours
  pattern: [1],
  unit: 'week',
  rank: 200
},</p>
</td><td class="code"><div class="highlight"><pre>    
          <span class="nx">christmas</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;publicHoliday&#39;</span><span class="p">,</span> <span class="c1">//Christmas</span>
                       <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;25 dec 2000 6am&#39;</span><span class="p">),</span>
                       <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                       <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span>
                       <span class="nx">length</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
                       <span class="nx">rank</span><span class="o">:</span> <span class="mi">300</span>
                     <span class="p">},</span>
          <span class="nx">boxing</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;publicHoliday&#39;</span><span class="p">,</span> <span class="c1">//Boxing day</span>
                    <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;26 dec 2000 6am&#39;</span><span class="p">),</span>
                    <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span>
                    <span class="nx">length</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
                    <span class="nx">rank</span><span class="o">:</span> <span class="mi">300</span>
                  <span class="p">},</span>
          <span class="nx">oneoff</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;publicHoliday&#39;</span><span class="p">,</span> <span class="c1">//one off public holiday</span>
                    <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;5 March 2013 6am&#39;</span><span class="p">),</span>
                    <span class="nx">pattern</span><span class="o">:</span> <span class="p">[],</span> <span class="c1">//doesn&#39;t pattern...</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>unit: 'year',</p>
</td><td class="code"><div class="highlight"><pre>                    <span class="nx">length</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
                    <span class="nx">rank</span><span class="o">:</span> <span class="mi">300</span>
                  <span class="p">},</span>
          <span class="nx">monthly</span><span class="o">:</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;monthly event&#39;</span><span class="p">,</span> 
                     <span class="nx">date</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;5 March 2000 6am&#39;</span><span class="p">),</span>
                     <span class="nx">pattern</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                     <span class="nx">unit</span><span class="o">:</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span>
                     <span class="nx">length</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
                     <span class="nx">rank</span><span class="o">:</span><span class="mi">100</span> 
                   <span class="p">}</span>
      <span class="p">};</span>
      
      <span class="kd">function</span> <span class="nx">setPatternsObject</span><span class="p">(</span><span class="nx">patternsObject</span><span class="p">)</span> <span class="p">{</span>
          <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">patternsObject</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span>
              <span class="nx">patternsObject</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
              <span class="nx">patternsArray</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">patternsObject</span><span class="p">[</span><span class="nx">p</span><span class="p">]);</span>
          <span class="p">});</span>

          <span class="nx">patternsArray</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">sortBy</span><span class="p">(</span><span class="nx">patternsArray</span><span class="p">,</span> <span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">);</span>
          <span class="nx">patternsArray</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
                  <span class="nx">p</span><span class="p">.</span><span class="nx">repeat</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">sum</span><span class="p">,</span> <span class="nx">elem</span><span class="p">)</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="nx">sum</span> <span class="o">+</span> <span class="nx">elem</span><span class="p">;</span>
                  <span class="p">},</span><span class="mi">0</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">unit</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unit</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unit</span><span class="p">.</span><span class="nx">lenght</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                  <span class="nx">p</span><span class="p">.</span><span class="nx">unit</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">unit</span> <span class="o">+</span> <span class="s1">&#39;s&#39;</span><span class="p">;</span> <span class="c1">//for Date.js: .add(x)[unit]()</span>
              <span class="nx">p</span><span class="p">.</span><span class="nx">logicalDate</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">today</span><span class="p">().</span><span class="nx">set</span><span class="p">({</span>
                  <span class="nx">year</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span>
                  <span class="nx">month</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(),</span>
                  <span class="nx">day</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="p">});</span>
          <span class="p">});</span>
      <span class="p">}</span>
      
      <span class="kd">function</span> <span class="nx">sameDay</span><span class="p">(</span><span class="nx">d1</span><span class="p">,</span> <span class="nx">d2</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">d1</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">===</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
              <span class="nx">d1</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">===</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
              <span class="nx">d1</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">===</span> <span class="nx">d2</span><span class="p">.</span><span class="nx">getDate</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">checkTime</span><span class="p">(</span><span class="nx">shift</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">start1</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">end1</span> <span class="o">=</span> <span class="nx">start1</span> <span class="o">+</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span> <span class="o">*</span> <span class="mi">60</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">start2</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">end2</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">endDate</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">endDate</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">();</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">start1</span> <span class="o">&gt;=</span> <span class="nx">end2</span> <span class="o">||</span> <span class="nx">end1</span> <span class="o">&lt;=</span> <span class="nx">start2</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">start1</span> <span class="o">&gt;</span> <span class="nx">start2</span> <span class="o">?</span> <span class="nx">start1</span> <span class="o">:</span> <span class="nx">start2</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">end1</span> <span class="o">&lt;</span> <span class="nx">end2</span> <span class="o">?</span> <span class="nx">end1</span> <span class="o">:</span> <span class="nx">end2</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span><span class="p">;</span>
          <span class="k">return</span> <span class="p">{</span>
              <span class="nx">pattern</span><span class="o">:</span> <span class="nx">pattern</span><span class="p">,</span> <span class="nx">length</span><span class="o">:</span> <span class="nx">length</span>   
          <span class="p">};</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">applyPattern</span><span class="p">(</span><span class="nx">shift</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">dayLength</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">weekLength</span> <span class="o">=</span> <span class="mi">7</span><span class="o">*</span><span class="nx">dayLength</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">patternLength</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">dateToCheck</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">diff</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">pattern</span> <span class="o">||</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">sameDay</span><span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">))</span> <span class="k">return</span> <span class="nx">checkTime</span><span class="p">(</span><span class="nx">shift</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">);</span>
          <span class="p">}</span>  
          <span class="k">else</span> <span class="p">{</span>
              <span class="nx">patternLength</span> <span class="o">=</span> <span class="nx">dayLength</span> <span class="o">*</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">repeat</span><span class="p">;</span> 
              <span class="k">switch</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">unit</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">&#39;weeks&#39;</span><span class="o">:</span>
                  <span class="nx">patternLength</span> <span class="o">=</span> <span class="nx">weekLength</span> <span class="o">*</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">repeat</span><span class="p">;</span> 
                <span class="k">case</span> <span class="s1">&#39;days&#39;</span><span class="o">:</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>log.d('days', shift.startDate);</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="nx">diff</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">logicalDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>
                  <span class="nx">dateToCheck</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">diff</span><span class="o">/</span><span class="nx">patternLength</span><span class="p">)</span> <span class="o">*</span> <span class="nx">patternLength</span><span class="p">;</span>
                  <span class="nx">dateToCheck</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">dateToCheck</span><span class="p">);</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>log.d(dateToCheck);</p>
</td><td class="code"><div class="highlight"><pre>                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;months&#39;</span><span class="o">:</span>
                  <span class="nx">diff</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">-</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span>
                      <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">-</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getYear</span><span class="p">())</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span>
                  <span class="nx">patternLength</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">repeat</span><span class="p">;</span>
                  <span class="nx">dateToCheck</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
                  <span class="kd">var</span> <span class="nx">monthToCheck</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">diff</span><span class="o">/</span><span class="nx">patternLength</span><span class="p">)</span> <span class="o">*</span> <span class="nx">patternLength</span><span class="p">;</span>
                  <span class="nx">dateToCheck</span><span class="p">.</span><span class="nx">addMonths</span><span class="p">(</span><span class="nx">monthToCheck</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s1">&#39;years&#39;</span><span class="o">:</span>
                  <span class="nx">diff</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">-</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getYear</span><span class="p">();</span>
                  <span class="nx">patternLength</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">repeat</span><span class="p">;</span>
                  <span class="nx">dateToCheck</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
                  <span class="kd">var</span> <span class="nx">yearToCheck</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">diff</span><span class="o">/</span><span class="nx">patternLength</span><span class="p">)</span> <span class="o">*</span> <span class="nx">patternLength</span><span class="p">;</span>
                  <span class="nx">dateToCheck</span><span class="p">.</span><span class="nx">setYear</span><span class="p">(</span><span class="nx">yearToCheck</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">);</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="k">default</span><span class="o">:</span> <span class="nx">log</span><span class="p">.</span><span class="nx">e</span><span class="p">(</span><span class="s1">&#39;unknown pattern unit:&#39;</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">unit</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="kd">var</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
              <span class="kd">var</span> <span class="nx">counter</span><span class="p">;</span>
              <span class="k">for</span> <span class="p">(</span><span class="nx">counter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">counter</span> <span class="o">&lt;</span> <span class="nx">max</span><span class="p">;</span> <span class="nx">counter</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">sameDay</span><span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">startDate</span><span class="p">,</span> <span class="nx">dateToCheck</span><span class="p">))</span> <span class="p">{</span>
                      <span class="k">return</span> <span class="nx">checkTime</span><span class="p">(</span><span class="nx">shift</span><span class="p">,</span><span class="nx">pattern</span><span class="p">);</span>
                  <span class="p">}</span>
                  <span class="nx">dateToCheck</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">pattern</span><span class="p">[</span><span class="nx">counter</span><span class="p">])[</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">unit</span><span class="p">]();</span>
              <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
 
      <span class="kd">function</span> <span class="nx">getWorkHourFields</span><span class="p">(</span><span class="nx">shift</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">location</span> <span class="o">&amp;&amp;</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">workHoursPattern</span><span class="p">)</span>
              <span class="nx">setPatternsObject</span><span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">workHoursPattern</span><span class="p">);</span>
          
          <span class="kd">var</span> <span class="nx">qualifiers</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="kd">var</span> <span class="nx">rank</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">patternsArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="nx">patternsArray</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
              <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">applyPattern</span><span class="p">(</span><span class="nx">shift</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">);</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">rank</span><span class="p">)</span> <span class="p">{</span>
                      <span class="k">if</span> <span class="p">(</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">rank</span> <span class="o">&gt;=</span> <span class="nx">rank</span><span class="p">)</span> <span class="p">{</span>
                          <span class="nx">qualifiers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>                   
                          <span class="nx">rank</span> <span class="o">=</span> <span class="nx">pattern</span><span class="p">.</span><span class="nx">rank</span><span class="p">;</span>
                      <span class="p">}</span> 
                      <span class="k">else</span> <span class="k">break</span><span class="p">;</span>
                  <span class="p">}</span>
                  <span class="k">else</span> <span class="nx">qualifiers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>                   
              <span class="p">}</span>
          <span class="p">}</span>
          
          <span class="kd">var</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{};</span>
          <span class="nx">qualifiers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
              <span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="o">%</span><span class="mi">60</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
              <span class="nx">h</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">h</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
              <span class="nx">fields</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">pattern</span><span class="p">.</span><span class="nx">type</span><span class="p">]</span> <span class="o">=</span> <span class="nx">h</span><span class="p">;</span>
          <span class="p">});</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">fields</span><span class="p">.</span><span class="nx">publicHoliday</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">workedOnPublicHoliday</span><span class="p">)</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">publicHolidayWorked</span> <span class="o">=</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">publicHoliday</span><span class="p">;</span>
              <span class="k">else</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">publicHolidayNotWorked</span> <span class="o">=</span> <span class="nx">fields</span><span class="p">.</span><span class="nx">publicHoliday</span><span class="p">;</span>
          <span class="p">}</span> 
          
          <span class="k">return</span> <span class="nx">fields</span><span class="p">;</span>
      <span class="p">}</span>
    
      <span class="nx">setPatternsObject</span><span class="p">(</span><span class="nx">defaultPatternsObject</span><span class="p">);</span>
      </pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>function test(n) {
    var shifts = [];</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><pre><code>var s;
for (var i = 0; i&lt; n; i++) {
    s = makeShift('1 Jan', 15,0,23,0);
    s.date = s.date.addDays(i);
    s.startDate = s.startDate.addDays(i);
    s.endDate = s.endDate.addDays(i);
    shifts.push(s);
}
var fields;
shifts.forEach(function(s) {
    var str = '';
    fields = getWorkHourFields(s);
    Object.keys(fields).forEach(function(f) {
        str += f + ' ' + fields[f] + ' ';
    });
    log.i(s.toString() + ':' + str);
});
console.log('done');
</code></pre>

<p>}</p>
</td><td class="code"><div class="highlight"><pre>      
      <span class="k">return</span> <span class="p">{</span>
          <span class="nx">setPatterns</span><span class="o">:</span> <span class="nx">setPatternsObject</span><span class="p">,</span>
          <span class="nx">getWorkHourFields</span><span class="o">:</span> <span class="nx">getWorkHourFields</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>,makeShift: makeShift
,test: test</p>
</td><td class="code"><div class="highlight"><pre>      <span class="p">};}});</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Thu Jan 17 2013 03:12:19 GMT+1000 (EST)  </div></div></body></html>