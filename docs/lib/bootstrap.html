<!DOCTYPE html>  <html> <head>   <title>bootstrap.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="bootstrap.html">                 bootstrap.js               </a>                                           <a class="source" href="date.html">                 date.js               </a>                                           <a class="source" href="font.html">                 font.js               </a>                                           <a class="source" href="livepage.html">                 livepage.js               </a>                                           <a class="source" href="logger.html">                 logger.js               </a>                                           <a class="source" href="pouch.alpha.min.html">                 pouch.alpha.min.js               </a>                                           <a class="source" href="pouch.alphal.html">                 pouch.alphal.js               </a>                                           <a class="source" href="pouch.html">                 pouch.js               </a>                                           <a class="source" href="utils.html">                 utils.js               </a>                                           <a class="source" href="vow.html">                 vow.js               </a>                                           <a class="source" href="when.html">                 when.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               bootstrap.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global jasmine:false bootstrap:false */</span>
<span class="cm">/*jshint strict:true unused:true smarttabs:true eqeqeq:true immed: true undef:true*/</span>
<span class="cm">/*jshint maxparams:5 maxcomplexity:9 maxlen:190 devel:true*/</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>TODO</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p><em>move these notes to a org/mm file
* use arbor.js to visualize the dependency relationships...
http://jsfiddle.net/NvMEu/5/
this is a link for a method of having a callback on load of css, copy of it see the bottom of this file
*make a minimal version (strip out console, executeLater/executeASAP and more?)
*make a node or picolisp script that concatenates all files and puts the right calls between files
*</em>> as a first step make a list of the files that will be concatenated together.. You would need the
executeLater mode, and disable the loadResource mechanism. <br />
*Maybe load js files in stages? Or all together? Or before the html load? Or after?
* replace executelater/asap with dom ready events or other events, to be inserted into the dependency lists?
* make the loaders plugins external to this file and comply the amd spec a bit more, advantage is that this
file becomes smaller, more custom loaders could be added easily, and also used as standalone loaders in the modules. 
Disadvantage is that there are more network requests, one for every loader, and that the bootstrap code
would have to be modified for this to accomodate loading dependencies for loading dependencies..
*have an amd! loader, it would conform to the amd spec for defining modules, so that for example we can load underscore.
*concatenate and uglify and offer for download a bundled compressed production mode bootstrap in the browser, maybe by entering a command in the console? Or by setting a config optionj
* don't try to execute callbacks if you've just queued dependencies to be loaded...
* what's going with onloaded event and jasmine? It just does not always fire... Also not in firefox
and even when it does, it seems to fire to early as far as the javascript is concerned, jasmine gives 
errors for undefined views etc. So I put execJasmine(); straight into my onload event, when bootstrap is 
finished loading everything, including the modules.
* once bootstrap has run at least once, it knows what files to download, so you could hardwire them, insert
them all at once, and have them load parallel. But in dynamic mode you can easily adjust dependencies. 
* make a index.html that links to a number of testpages, one with basic tests, one that correctly fails, one with
very complicated interdependencies etc...</p>

<p>Notes:
1. To load non-module files in a certain order, concatenate them into one js file, insert them directly
in the html file with script source statements, or inject or load them in a module marking them with
a | after the url to indicate that they should block till they are loaded (and executed!) </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <ol>
<li>Cyclic dependancies!! Possible, but a module that requires another module that directly or 
indirectly requires the first module cannot use any public api of the first module upon invocation
of the callback, since the callback of the first module has not been called yet at that moment. 
However after this has happened (the callback of the first module) the second module can use it again.
At the moment bootstrap gives an error and halts. You could when you encounter a circular dependency 
just declare the dependency met, and continue. You would end up in the situation just described..</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <ol>
<li>To concatenate all the files together you would have to insert statements between the concatenated files,
such as: setfolderpath(pathToFolderFileUsedToBeIn), so that when the defines get executed bootstrapjs knows
in what namespace to put the defined factories, ofcourse all the load directives would become superfluous 
because they don't have to be loadedjanymore by bootstrap. The inject directive becomes just an instruction 
what objects to insert, not what files to load anymore. You can concatenate them in any order, bootstrap would 
still control the order of the execution of the callbacks, though you might might want to put the non bootstrap
ffiles first. You could set it up so that just before bootstrap executes the callbacks, it would check wther all
the dependency objects are there, and if not it would again try to download them.</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>4 I talk interchangeably about defines and modules throughout this source code, however
these can be configured to be named anything you want, by setting the appropriate config variable.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>datastructures:
resource = {
  id: loader!url
  url: relative or absolute path
  loader: "data, css or js, or bootstrap"
  status: new, requested, loaded, callbacks_executed
  blocks : boolean
  definers: definers defined in this resource <br />
  namespace: where to store this resource 
}</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>dependency = {
  id: resource.id#tag
  resource: file this dependency would like to load
  tag: subid if there more than one id per file, no tag is an empty string tag
  definer: definer that is referred by by the resource#tag combo
  met: boolean, has resourceLoaded been called if it is css or data,
                has the callback been executed if it is a definer
  requirers: array of definers that asks for this dependency
  dependencies: array of dependencies whose resources have to be loaded and
                its appropriate (tag) definer executed
                before this dependency's callback can be executed
  isBonus: the definer was found in a file but was not the definer
            that the dependency was after
}</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>definer = {
  tag: "string", 
  load: array of files,
  inject: array of files, to inserted into factory
  factory; module code/dat</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>------------- internal attributes---------------------
  dependency: the dependency that wants this definer
}</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Bootstrap</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">)</span>
 <span class="p">{</span> <span class="s2">&quot;use strict&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>VERSION = '0.4',
DATE = '26/12/12',</p>             </td>             <td class="code">               <div class="highlight"><pre>   </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>debug variables that watch out for infinite loops shouldn't
happen, but till I have full faith in the algorythm I rather have
an error than a hanging browser. Increase them if you get an error</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">var</span> <span class="nx">exeOrderMax</span> <span class="o">=</span> <span class="mi">600</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">backtrackMax</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">biggestExeOrder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   
   <span class="kd">var</span> <span class="nx">default_config</span> <span class="o">=</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>-----hook
Name of the global function that modularizes a file by defining other files to load and taking a an optional 
callback or other object that defines the functionality of the module. </p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">hook</span><span class="o">:</span> <span class="s1">&#39;define&#39;</span><span class="p">,</span>
       </pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>-----namespace
All objects created by the callbacks are added to the object global.namespace.url
So for instance if a module is defined in javascript/dir1/dir2/dir3/module1.js 
(relative to the html file that loaded bootstrap.js, this file)
,assuming global=window and namespace=module and pathPrefix=javascript
and paths[myapp]='dir1/dir2' then the object created will be:
window.module.myapp.dir3.module1, which can be injected with myapp.dir3.module1
If this variable is not defined at all objects are stored internally
and not accessible outside the module</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">namespace</span><span class="o">:</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">,</span>
       </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>-----global pathPrefix
Load files relative to this path</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">pathPrefix</span><span class="o">:</span> <span class="s2">&quot;test/&quot;</span><span class="p">,</span>
       </pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>-----paths 
a way to map namespaces to directories. This way you can refer to modules defined in 
separate rootfolders by prefixing the object name with its subsitution</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">paths</span><span class="o">:</span> <span class="p">{</span>
     <span class="nx">mypath</span><span class="o">:</span> <span class="s1">&#39;a1/b1&#39;</span>
       <span class="p">},</span>
       </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>-----main <br />
First javascript file to load, the bootstrap so to speak</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">main</span><span class="o">:</span> <span class="s1">&#39;myapp&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>main: 'main',</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>-----scriptInsertionLocation
Head or body, or any other element</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">scriptInsertionLocation</span> <span class="o">:</span> <span class="s1">&#39;head&#39;</span><span class="p">,</span>
       </pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>-----timeOut 
in seconds  </p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">timeOut</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
       </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>-----verbose
none, error, warn, info, debug </p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">verbosity</span><span class="o">:</span> <span class="s2">&quot;debug&quot;</span><span class="p">,</span>
       </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>-----onExecute
gets called right before all module callbacks get executed
gets as an argument a function that executes these callbacks.
useful to implement waiting for domready event for instance:
execute: function myExecute(f) {
  // Check for browser support of event handling capability
  if (window.addEventListener)
    window.addEventListener("load", f, false);
  else if (window.attachEvent) window.attachEvent("onload", f);
  else window.onload = f;
},
if falsy all callbacks get executed asap
onExecute: onExecute_native,</p>             </td>             <td class="code">               <div class="highlight"><pre>       </pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>-----onLoaded 
Gets called when all files are loaded and all callbacks executed</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">onLoaded</span><span class="o">:</span> <span class="nx">onLoaded_native</span><span class="p">,</span>
       </pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>-------testing</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">testing</span><span class="o">:</span> <span class="kc">true</span>
       
   <span class="p">},</span>
   </pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>----initHook [string]
the init function is added to the hook under this name
falsy will result in not anything being added, and will start
the  bootstrap process by itself, otherwise calling hook<a href="">initHook</a>
will do this, with an optional config object as argument.  </p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="nx">initHook</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
     </pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>config vars    </p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="nx">namespace</span><span class="p">,</span> <span class="nx">pathPrefix</span> <span class="p">,</span><span class="nx">main</span><span class="p">,</span> <span class="nx">scriptInsertionLocation</span><span class="p">,</span> 
       <span class="nx">hook</span><span class="p">,</span> <span class="nx">timeOut</span><span class="p">,</span> <span class="nx">verbosity</span><span class="p">,</span> <span class="nx">insertionLocation</span><span class="p">,</span> 
       <span class="nx">paths</span><span class="p">,</span> <span class="nx">executeASAP</span><span class="p">,</span> 
   <span class="nx">onExecute</span><span class="p">,</span> <span class="nx">onLoaded</span><span class="p">,</span>
     </pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>internal vars</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="nx">resources</span><span class="p">,</span> <span class="nx">definers</span><span class="p">,</span> <span class="nx">dependencies</span><span class="p">,</span>
       <span class="nx">definers_called</span><span class="p">,</span> <span class="nx">requests_pending</span><span class="p">,</span> <span class="nx">timeouts_pending</span><span class="p">,</span> 
       <span class="nx">blocking</span><span class="p">,</span> <span class="nx">depstack</span><span class="p">,</span> <span class="nx">maindep</span><span class="p">,</span> <span class="nx">error</span><span class="p">,</span> <span class="nx">testing</span><span class="p">,</span>
     </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>returns a timestamp in ms without arguments,</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="nx">timeStamp</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="kd">var</span> <span class="nx">bootstart</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
     <span class="k">return</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="o">-</span> <span class="nx">bootstart</span><span class="p">;};})(),</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>log with levels  eg: log(W,"bla");</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="nx">E</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nx">W</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="nx">I</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="nx">D</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
   <span class="nx">levels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39;debug&#39;</span><span class="p">];</span>
     </pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">log</span><span class="p">()</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>
       <span class="kd">var</span> <span class="nx">level</span> <span class="o">=</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
       <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">timeStamp</span><span class="p">();</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">&lt;=</span> <span class="nx">verbosity</span><span class="p">)</span> <span class="nx">console</span><span class="p">[</span><span class="nx">levels</span><span class="p">[</span><span class="nx">level</span><span class="p">]].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">console</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
   <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">init</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>make sure all config vars have at least some default value</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">config</span><span class="p">)</span> <span class="nx">config</span> <span class="o">=</span> <span class="nx">default_config</span><span class="p">;</span>
       
       <span class="nx">hook</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">hook</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">hook</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">global</span><span class="p">[</span><span class="nx">hook</span><span class="p">])</span> <span class="nx">log</span><span class="p">(</span><span class="nx">W</span><span class="p">,</span><span class="s2">&quot;Warning: hook &#39;&quot;</span> <span class="o">+</span> <span class="nx">hook</span> <span class="o">+</span> <span class="s2">&quot;&#39; already exists&quot;</span><span class="p">);</span>
       <span class="nx">global</span><span class="p">[</span><span class="nx">hook</span><span class="p">]</span><span class="o">=</span> <span class="nx">define</span><span class="p">;</span>
       
       <span class="nx">namespace</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">namespace</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>base object to assign our factories to</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">namespace</span> <span class="o">=</span> <span class="nx">namespace</span> <span class="o">?</span> <span class="nx">getObject</span><span class="p">(</span><span class="nx">global</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
       
       <span class="nx">pathPrefix</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">config</span><span class="p">.</span><span class="nx">pathPrefix</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span>  
     <span class="nx">default_config</span><span class="p">.</span><span class="nx">pathPrefix</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">pathPrefix</span><span class="p">;</span>
       <span class="nx">main</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">main</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
       <span class="nx">scriptInsertionLocation</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">scriptInsertionLocation</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">scriptInsertionLocation</span><span class="p">;</span>
       <span class="nx">insertionLocation</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="nx">scriptInsertionLocation</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
       <span class="nx">timeOut</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">timeOut</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">timeOut</span><span class="p">;</span>
       
       <span class="nx">verbosity</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">verbosity</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">?</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">verbosity</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">verbosity</span><span class="p">;</span>
       <span class="nx">verbosity</span> <span class="o">=</span> <span class="nx">levels</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">verbosity</span><span class="p">);</span>
       
       <span class="nx">paths</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">paths</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">paths</span><span class="p">;</span>
       <span class="nx">onExecute</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">onExecute</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">onExecute</span><span class="p">;</span>
       <span class="nx">onLoaded</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">onLoaded</span> <span class="o">||</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">onLoaded</span><span class="p">;</span>
       <span class="nx">executeASAP</span> <span class="o">=</span> <span class="nx">onExecute</span> <span class="o">?</span> <span class="kc">false</span> <span class="o">:</span> <span class="kc">true</span><span class="p">;</span>
       <span class="nx">testing</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">config</span><span class="p">.</span><span class="nx">testing</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">default_config</span><span class="p">.</span><span class="nx">testing</span> <span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">testing</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>make sure every path ends with a slash </p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">paths</span><span class="p">)</span> 
     <span class="k">if</span> <span class="p">(</span><span class="nx">paths</span><span class="p">[</span><span class="nx">p</span><span class="p">][</span><span class="nx">paths</span><span class="p">[</span><span class="nx">p</span><span class="p">].</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
         <span class="nx">paths</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span> 
       <span class="k">if</span> <span class="p">(</span><span class="nx">pathPrefix</span><span class="p">[</span><span class="nx">pathPrefix</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="nx">pathPrefix</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
       </pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>initialize internal vars 
the first three are objects to keep track of unique instances of their members.</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">resources</span> <span class="o">=</span> <span class="p">{};</span>
       <span class="nx">definers</span> <span class="o">=</span> <span class="p">{};</span>
       <span class="nx">dependencies</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>just to bridge the callback from request to response of js,css and data</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">definers_called</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>if there are no more requests, we're finished...</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">requests_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="nx">timeouts_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>set to true if a dependency id ends in |</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">blocking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>when blocking any further requests are stacked here, 
till the blocking resource responds</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">depstack</span> <span class="o">=</span> <span class="p">[];</span>
       </pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>start off bootstrap</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">initHook</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">global</span><span class="p">[</span><span class="nx">hook</span><span class="p">][</span><span class="nx">initHook</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
     <span class="nx">global</span><span class="p">[</span><span class="nx">hook</span><span class="p">][</span><span class="nx">initHook</span><span class="p">]</span> <span class="o">=</span> <span class="nx">init</span><span class="p">;</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s2">&quot;Finished the bootstrap script, start loading the scripts with &quot;</span> <span class="o">+</span> 
         <span class="nx">hook</span> <span class="o">+</span> <span class="s2">&quot;.init({...config...})&quot;</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s2">&quot;Loading first javascript file: &quot;</span> <span class="o">+</span> <span class="nx">main</span> <span class="o">+</span> <span class="s2">&quot;.js&quot;</span><span class="p">);</span>
     <span class="nx">maindep</span> <span class="o">=</span> <span class="nx">parseDependencyId</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
     <span class="nx">maindep</span><span class="p">.</span><span class="nx">exeOrder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="nx">requestResource</span><span class="p">(</span><span class="nx">maindep</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>after timeOut seconds timedOut get called which checks whether all scripts and resources have been loaded
and gives an error messages if they are not.</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">timedOut</span><span class="p">,</span> <span class="nx">timeOut</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
       <span class="p">}</span>
   <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <hr />

<p>called after timeOut seconds. Checks if all requested resources have actually been loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">timedOut</span><span class="p">()</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">noresponse</span> <span class="o">=</span> <span class="p">[];</span>
           <span class="k">if</span> <span class="p">(</span><span class="nx">requests_pending</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span> <span class="s1">&#39;requests pending&#39;</span><span class="p">,</span> <span class="nx">requests_pending</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">timeouts_pending</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span> <span class="s1">&#39;timeouts pending&#39;</span><span class="p">,</span> <span class="nx">timeouts_pending</span><span class="p">);</span>
       <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">d</span> <span class="k">in</span> <span class="nx">dependencies</span><span class="p">)</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">d</span><span class="p">].</span><span class="nx">resource</span><span class="p">.</span><span class="nx">status</span> <span class="o">!==</span> <span class="s1">&#39;loaded&#39;</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">noresponse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">d</span><span class="p">]);</span> 
     <span class="p">}</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">noresponse</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span><span class="s2">&quot;Timed out. Unloaded dependencies:&quot;</span><span class="p">);</span>
     <span class="nx">noresponse</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span><span class="nx">r</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="p">});</span> <span class="p">}</span> 
       <span class="nx">noresponse</span> <span class="o">=</span> <span class="p">[];</span>
       <span class="k">for</span> <span class="p">(</span><span class="nx">d</span> <span class="k">in</span> <span class="nx">dependencies</span><span class="p">)</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">d</span><span class="p">].</span><span class="nx">met</span> <span class="o">&amp;&amp;</span> <span class="nx">dependencies</span><span class="p">[</span><span class="nx">d</span><span class="p">].</span><span class="nx">requirers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">noresponse</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">d</span><span class="p">]);</span> 
     <span class="p">}</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">noresponse</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span><span class="s2">&quot;Timed out. Unresolved dependencies:&quot;</span><span class="p">);</span>
     <span class="nx">noresponse</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span><span class="nx">r</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> <span class="p">});</span> <span class="p">}</span> 
       
   <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <hr />

<p>when given a path of a/b/c and a ns of base, object base.a.b.c is returned, creating
the objects that don't exist yet, and assigning value to the end of the path (c)</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">getObject</span><span class="p">(</span><span class="nx">ns</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">namespace</span><span class="p">)</span> <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>log(E, 'making namespace for ', path);</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
     <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="o">===</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                 <span class="nx">ns</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> 
             <span class="p">}</span>
             <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">ns</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>ns[parts[i]] = {}; //Object.create(null);</p>             </td>             <td class="code">               <div class="highlight"><pre>                 <span class="nx">ns</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
             <span class="p">}</span>
             <span class="nx">ns</span> <span class="o">=</span> <span class="nx">ns</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
       <span class="k">return</span> <span class="nx">ns</span><span class="p">;</span> <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <hr />

<p>This inserts a script or css element into the dom, which causes an 
async load of the file, or does an xhr request for a file.  For both
onload events resourceLoaded is eventually called.</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">requestResource</span><span class="p">(</span><span class="nx">dependency</span><span class="p">)</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">;</span>
       <span class="nx">requests_pending</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;requested&#39;</span><span class="p">;</span> </pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>xhr and css tag insertion </p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">!==</span> <span class="s1">&#39;js&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">!==</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">)</span> 
       <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">!==</span> <span class="s1">&#39;css&#39;</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s2">&quot;Making xhr request for &quot;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
     <span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span><span class="p">;</span> <span class="p">}</span>
   <span class="k">else</span> <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s2">&quot;Inserting css: &quot;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>call one of the loaders defined at the bottom of this file</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="nx">loaders</span><span class="p">[</span><span class="nx">res</span><span class="p">.</span><span class="nx">loader</span><span class="p">].</span><span class="nx">load</span><span class="p">(</span>
       <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> 
       <span class="p">{</span> <span class="nx">toUrl</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">url</span><span class="p">;</span> <span class="p">}},</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>callback for xhr and css</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>we only care about the data callback
if (res.loader === 'data')  {
pop the data in the namespace tree 
log(D, 'popping result in namespace..', res.namespace, result);
if (res.isAbs) namespace[res.url] = result;
else dependency.value = getObject(namespace, dependency.namespace, result);</p>             </td>             <td class="code">               <div class="highlight"><pre>           <span class="nx">dependency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span> 
           <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">===</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">W</span><span class="p">,</span> <span class="s1">&#39;empty response from xhr request&#39;</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">result</span> <span class="o">&amp;&amp;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">===</span> <span class="s1">&#39;css&#39;</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">W</span><span class="p">,</span> <span class="s1">&#39;empty response from css link insertion ???&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>}</p>             </td>             <td class="code">               <div class="highlight"><pre>           <span class="nx">log</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span> <span class="s1">&#39;calling resourceLoaded from css/xhr&#39;</span><span class="p">);</span>
           <span class="nx">resourceLoaded</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span>
       <span class="p">},</span>
       <span class="p">{</span><span class="cm">/*config*/</span><span class="p">});</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>insert javascript tag</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">else</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">script_element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
        <span class="nx">script_element</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
        <span class="nx">script_element</span><span class="p">.</span><span class="nx">onloadDone</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">script_element</span><span class="p">.</span><span class="nx">defer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="nx">script_element</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">script_element</span><span class="p">.</span><span class="nx">onloadDone</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>
      <span class="nx">resourceLoaded</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span>
        <span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>// IE 6 &amp; 7
script<em>element.onreadystatechange = function() {
  if (script</em>element.readyState == 'loaded' &amp;&amp; !script<em>element.onloadDone) {
    script</em>element.onloadDone = true;
    resourceLoaded(dependency, requirer);
  }
};</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">insertionLocation</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">script_element</span><span class="p">);</span>
        <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;Inserting script tag for: &#39;</span><span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">url</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">blocks</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s1">&#39;Blocking any further script injections till this one has run&#39;</span><span class="p">);</span> <span class="p">}</span>
   <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <hr />

<p>the only global to leak out of this closure, under a name set in the configuration 
these functions get executed right after a js file has been loaded by the browser
we collect the arguments to these calls here. To conform more to the AMD specs
you would adapt this function, by analyzing the arguments and creating a standard
definer object {tag:.., load:.., inject:.., factory:..} to add to definers_called </p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">define</span><span class="p">(</span><span class="nx">definer</span><span class="p">)</span> <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>fix up this new definer</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">definer</span><span class="p">.</span><span class="nx">tag</span><span class="p">)</span> <span class="nx">definer</span><span class="p">.</span><span class="nx">tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">definer</span><span class="p">.</span><span class="nx">load</span><span class="p">)</span> <span class="nx">definer</span><span class="p">.</span><span class="nx">load</span> <span class="o">=</span> <span class="p">[];</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">definer</span><span class="p">.</span><span class="nx">inject</span><span class="p">)</span> <span class="nx">definer</span><span class="p">.</span><span class="nx">inject</span> <span class="o">=</span> <span class="p">[];</span>
       <span class="nx">definers_called</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">definer</span><span class="p">);</span> <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <hr />

<p>called immediately by the browser after script is loaded and then executed
beginning of thread</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">resourceLoaded</span><span class="p">(</span><span class="nx">dependency</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> 
       <span class="nx">requests_pending</span><span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>bookkeeping</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s2">&quot;************Processing: &quot;</span> <span class="o">+</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;*************  &#39;</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">&amp;&amp;</span> <span class="nx">blocking</span><span class="p">)</span> <span class="nx">blocking</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
       <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;loaded&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>to prevent files with .js extension to be interpreted as bootstrap files with
definers in them we check for the loader type (only dependencies without an extension
are interpreted as bootstrap files), otherwise you can't load files that happen to do a
define call</p>             </td>             <td class="code">               <div class="highlight"><pre>           <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">loader</span> <span class="o">===</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">)</span>  
       <span class="p">{</span> <span class="nx">res</span><span class="p">.</span><span class="nx">definers</span> <span class="o">=</span>  <span class="nx">definers_called</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">resolved_dependencies</span> <span class="o">=</span> <span class="p">[];</span>
   <span class="nx">res</span><span class="p">.</span><span class="nx">definers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">def</span><span class="p">)</span> <span class="p">{</span> 
       <span class="kd">var</span> <span class="nx">depId</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">loader</span> <span class="o">+</span> <span class="s1">&#39;!&#39;</span> <span class="o">+</span> 
                 <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">def</span><span class="p">.</span><span class="nx">tag</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">depId</span><span class="p">])</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;Bonus definer found: &#39;</span> <span class="o">+</span> <span class="nx">depId</span><span class="p">);</span>
     <span class="nx">dependencies</span><span class="p">[</span><span class="nx">depId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">depId</span><span class="p">,</span> <span class="nx">requirers</span><span class="o">:</span> <span class="p">[],</span>
           <span class="nx">isBonus</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
           <span class="nx">resource</span><span class="o">:</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">,</span>
           <span class="nx">tag</span><span class="o">:</span> <span class="nx">def</span><span class="p">.</span><span class="nx">tag</span><span class="p">,</span>
           <span class="nx">namespace</span><span class="o">:</span>  <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">namespace</span> <span class="o">+</span> 
           <span class="p">(</span><span class="nx">def</span><span class="p">.</span><span class="nx">tag</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">def</span><span class="p">.</span><span class="nx">tag</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
           <span class="nx">dependencies</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span> <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s1">&#39;New definer added to dependency &#39;</span> <span class="o">+</span> <span class="nx">depId</span><span class="p">);</span>
     <span class="nx">resolved_dependencies</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">depId</span><span class="p">]);</span>
       <span class="p">}</span>
       <span class="nx">tieInDefiner</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">depId</span><span class="p">],</span> <span class="nx">def</span><span class="p">);</span> <span class="p">}</span> <span class="p">);</span> 
   <span class="nx">resolved_dependencies</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span> <span class="nx">processDependency</span><span class="p">(</span><span class="nx">dep</span><span class="p">);});</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="nx">processDependency</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span>
       <span class="nx">definers_called</span><span class="o">=</span><span class="p">[];</span> <span class="c1">//reset for the next script to come in</span>
       <span class="nx">endThread</span><span class="p">();</span>
   <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <hr />

<p>this will try to resolve any further dependencies this dependency has
and try to execute any callback
continued from resourceLoaded, or async called from resolveDeps, </p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">processDependency</span><span class="p">(</span><span class="nx">dependency</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span> 
       <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;*********processing dependency &#39;</span> <span class="o">+</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>see what else this dependency is going to need...</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">resolveDeps</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span> 
       
       <span class="k">switch</span> <span class="p">(</span><span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">loader</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">case</span> <span class="s1">&#39;data&#39;</span><span class="o">:</span><span class="nx">getObject</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="s1">&#39;js&#39;</span><span class="o">:</span> <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="s1">&#39;css&#39;</span> <span class="o">:</span> <span class="k">break</span><span class="p">;</span> 
       <span class="k">default</span><span class="o">:</span> 
     <span class="nx">dependency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">getObject</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">namespace</span><span class="p">);</span>
       <span class="p">}</span>
       <span class="nx">setExeOrder</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>and execute the callback if possible..</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">executeNow</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span>
   <span class="p">}</span>       
     
   <span class="kd">function</span> <span class="nx">endThread</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>now is the time to make any further requests for resources..</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">depstack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;Finally, request queued dependencies&#39;</span><span class="p">);</span> 
       <span class="k">while</span> <span class="p">(</span><span class="nx">depstack</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">blocking</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">var</span> <span class="nx">dependency</span> <span class="o">=</span> <span class="nx">depstack</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">blocks</span><span class="p">)</span> <span class="nx">blocking</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
     <span class="nx">requestResource</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span> 
       <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>as long as there are still requests pending don't finalize</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">requests_pending</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">timeouts_pending</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">finalize</span><span class="p">();</span> 
       <span class="p">}</span>
   <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>end of thread..</p>             </td>             <td class="code">               <div class="highlight"><pre>     </pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <hr />

<p>tie the definer to the dependency if tags match, otherwise make new dependencies, </p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">tieInDefiner</span><span class="p">(</span><span class="nx">dependency</span><span class="p">,</span> <span class="nx">definer</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">dependency</span><span class="p">.</span><span class="nx">definer</span> <span class="o">=</span> <span class="nx">definer</span><span class="p">;</span> 
       <span class="nx">definer</span><span class="p">.</span><span class="nx">dependency</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">;</span>
       <span class="nx">definer</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">definer</span><span class="p">.</span><span class="nx">tag</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>the following can happen if more than one definer in a file has the
the same tag, or no tag.</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">definers</span><span class="p">[</span><span class="nx">definer</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span> <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s2">&quot;Warning: redefining &quot;</span> <span class="o">+</span> <span class="nx">definer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span> 
       <span class="nx">definers</span><span class="p">[</span><span class="nx">definer</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">=</span><span class="nx">definer</span><span class="p">;</span>  
   <span class="p">}</span> 
     </pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <hr />

<p>do a depth-first search for all paths to the main node, setting exeOrders on the way  </p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">setExeOrder</span><span class="p">(</span><span class="nx">dependency</span><span class="p">)</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
       <span class="kd">var</span> <span class="nx">chain</span> <span class="o">=</span> <span class="p">[];</span>
       <span class="kd">function</span> <span class="nx">flowdown</span><span class="p">(</span><span class="nx">indent</span><span class="p">,</span> <span class="nx">dependency</span><span class="p">,</span> <span class="nx">exeOrder</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>log(, indent + 'Setting dependency ' + dependency.id + ' to ' + exeOrder);</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">chain</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dependency</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
     <span class="nx">dependency</span><span class="p">.</span><span class="nx">exeOrder</span> <span class="o">=</span> <span class="nx">exeOrder</span><span class="p">;</span>
     <span class="nx">dependency</span><span class="p">.</span><span class="nx">requirers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span>
         <span class="kd">function</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="nx">exeOrder</span> <span class="o">&gt;</span> <span class="nx">exeOrderMax</span><span class="p">)</span> <span class="p">{</span> <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span> <span class="s1">&#39;looping in  setExeOrder&#39;</span><span class="p">);</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
                   <span class="k">else</span> <span class="p">{</span>
                       <span class="k">if</span> <span class="p">(</span><span class="nx">exeOrder</span> <span class="o">&gt;</span><span class="nx">biggestExeOrder</span><span class="p">)</span> <span class="nx">biggestExeOrder</span> <span class="o">=</span> <span class="nx">exeOrder</span><span class="p">;</span>
                   <span class="p">}</span>
             <span class="k">if</span> <span class="p">(</span><span class="nx">dep</span> <span class="o">===</span> <span class="nx">dependency</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
             <span class="k">if</span> <span class="p">(</span><span class="nx">dep</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
                 <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span> <span class="s1">&#39;Cyclic dependency. &#39;</span><span class="p">);</span>
                 <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">chain</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span> <span class="nx">chain</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; requires --&gt;&#39;</span><span class="p">);</span>
                 <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                 <span class="nx">error</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                 <span class="k">throw</span><span class="p">(</span><span class="s2">&quot;Halting&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>return;</p>             </td>             <td class="code">               <div class="highlight"><pre>             <span class="p">}</span>
             <span class="nx">exeOrder</span> <span class="o">=</span> <span class="nx">flowdown</span><span class="p">(</span><span class="nx">indent</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="nx">dep</span><span class="p">,</span> <span class="nx">exeOrder</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
         <span class="p">});</span>
     <span class="nx">chain</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
     <span class="k">return</span> <span class="nx">exeOrder</span><span class="p">;</span> 
       <span class="p">}</span>
       <span class="nx">flowdown</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nx">dependency</span><span class="p">,</span> <span class="nx">maindep</span><span class="p">.</span><span class="nx">exeOrder</span><span class="p">);</span>
   <span class="p">}</span>
       </pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <hr />

<p>make more requests for resources, depending on the modules' load and inject arrays</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">resolveDeps</span><span class="p">(</span><span class="nx">dependency</span><span class="p">)</span> <span class="p">{</span>
       <span class="kd">function</span> <span class="nx">processDep</span><span class="p">(</span><span class="nx">depId</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">var</span> <span class="nx">dep_dependency</span> <span class="o">=</span> <span class="nx">parseDependencyId</span><span class="p">(</span><span class="nx">depId</span><span class="p">);</span>
     <span class="nx">dependency</span><span class="p">.</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep_dependency</span><span class="p">);</span>
     <span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">requirers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span> 
     <span class="k">if</span> <span class="p">(</span><span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;new&#39;</span><span class="p">)</span>   <span class="p">{</span>
               <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s1">&#39;queueing &#39;</span> <span class="o">+</span> <span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">id</span> <span class="p">);</span>
         <span class="nx">depstack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep_dependency</span><span class="p">);</span>
         <span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">status</span> <span class="o">=</span> <span class="s1">&#39;queued&#39;</span><span class="p">;</span> <span class="p">}</span>
     <span class="k">else</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="s1">&#39;loaded&#39;</span><span class="p">)</span> <span class="p">{</span>
             <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;The resource for this dependency has already been loaded: &#39;</span> <span class="o">+</span> <span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">id</span>  <span class="p">);</span> 
             <span class="k">if</span> <span class="p">(</span><span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">isBonus</span><span class="p">)</span> <span class="p">{</span>
                 <span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">isBonus</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>make quasi browser callback, as if we just loaded this new definer
though it had come for free with a previous resourceLoad</p>             </td>             <td class="code">               <div class="highlight"><pre>                 <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">timeouts_pending</span><span class="o">--</span><span class="p">;</span>
                       <span class="nx">processDependency</span><span class="p">(</span><span class="nx">dep_dependency</span><span class="p">);</span> 
                       <span class="nx">endThread</span><span class="p">();</span> <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>
                 <span class="nx">timeouts_pending</span><span class="o">++</span><span class="p">;</span>
                 <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;This is a bonus definer being activated.. ,setting callback&#39;</span><span class="p">);</span> 
             <span class="p">}</span>
         <span class="p">}</span> 
         <span class="k">else</span> <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s1">&#39;this dependency is already queued: &#39;</span> <span class="o">+</span> <span class="nx">dep_dependency</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>  
     <span class="p">}</span>
       <span class="p">}</span>
       <span class="kd">var</span> <span class="nx">definer</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">definer</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">definer</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s1">&#39;Resolving deps for &#39;</span> <span class="o">+</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="nx">definer</span><span class="p">.</span><span class="nx">load</span><span class="p">,</span> <span class="nx">definer</span><span class="p">.</span><span class="nx">inject</span><span class="p">);</span>
     <span class="nx">definer</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">processDep</span><span class="p">);</span>
     <span class="nx">definer</span><span class="p">.</span><span class="nx">inject</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">processDep</span><span class="p">);</span> <span class="p">}</span> 
   <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">executeNow</span><span class="p">(</span><span class="nx">dependency</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">executeASAP</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>function that, if all dependencies are met, executes the callback;</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">function</span> <span class="nx">testDeps</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>if (dep.definer.factory &amp;&amp; typeof dep.definer.factory === 'function') <br />
{ </p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="k">if</span> <span class="p">(</span><span class="nx">dep</span><span class="p">.</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">met</span><span class="p">;}))</span>
     <span class="p">{</span> <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s1">&#39;All dependencies have been met for &#39;</span> <span class="o">+</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">definer</span><span class="p">.</span><span class="nx">id</span> <span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>' ,executing the callback');
executeCallback(dep);</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}</span>
     <span class="k">else</span> <span class="p">{</span> <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s2">&quot;There are still dependencies missing for &quot;</span> <span class="o">+</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">definer</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>     </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>else return true; }</p>             </td>             <td class="code">               <div class="highlight"><pre>       
       <span class="nx">dependency</span><span class="p">.</span><span class="nx">met</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">loader</span> <span class="o">===</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">)</span>  <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;Trying to execute callback of &#39;</span> <span class="o">+</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
     <span class="kd">var</span> <span class="nx">depdef</span> <span class="o">=</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">definer</span><span class="p">;</span> 
     <span class="k">if</span> <span class="p">(</span><span class="nx">depdef</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">dependency</span><span class="p">.</span><span class="nx">met</span> <span class="o">=</span> <span class="nx">testDeps</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span> 
               <span class="k">if</span> <span class="p">(</span><span class="nx">dependency</span><span class="p">.</span><span class="nx">met</span><span class="p">)</span> <span class="p">{</span>
                   <span class="k">if</span> <span class="p">(</span><span class="nx">depdef</span><span class="p">.</span><span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
                       <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">depdef</span><span class="p">.</span><span class="nx">factory</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>   <span class="p">{</span>
                     <span class="nx">dependency</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">depdef</span><span class="p">.</span><span class="nx">factory</span><span class="p">;</span>
                       <span class="p">}</span>
                 <span class="k">else</span> <span class="nx">executeCallback</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>dependency.met = exe(dependency); }</p>             </td>             <td class="code">               <div class="highlight"><pre>                   <span class="p">}</span>
               <span class="p">}</span>
           <span class="p">}</span> 
     <span class="k">else</span>  <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>log(E,(definer ? "Definer " + definer.id  : main) + </p>             </td>             <td class="code">               <div class="highlight"><pre>         <span class="nx">log</span><span class="p">(</span><span class="nx">E</span><span class="p">,</span><span class="s1">&#39;One of &#39;</span><span class="p">,</span> <span class="nx">dependency</span><span class="p">.</span><span class="nx">requirers</span><span class="p">,</span> 
       <span class="s1">&#39; has asked for the dependency &#39;</span> <span class="o">+</span>  <span class="nx">dependency</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; in the resource &#39;</span> <span class="o">+</span>
       <span class="nx">dependency</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;, which has no matching definers.&#39;</span><span class="p">);</span>
         <span class="nx">dependency</span><span class="p">.</span><span class="nx">met</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>

       <span class="p">}</span>
       <span class="kd">var</span> <span class="nx">failsafe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
       <span class="kd">function</span> <span class="nx">backtrace</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">dep</span><span class="p">.</span><span class="nx">requirers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span>
         <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="nx">req</span> <span class="o">!==</span> <span class="nx">dep</span> <span class="o">&amp;&amp;</span> <span class="nx">testDeps</span><span class="p">(</span><span class="nx">req</span><span class="p">))</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>log(I, 'Executing callback');</p>             </td>             <td class="code">               <div class="highlight"><pre>                       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">met</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">definer</span><span class="p">.</span><span class="nx">factory</span><span class="p">)</span> <span class="p">{</span>
                           <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">req</span><span class="p">.</span><span class="nx">definer</span><span class="p">.</span><span class="nx">factory</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span>   <span class="p">{</span>
                         <span class="nx">req</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">definer</span><span class="p">.</span><span class="nx">factory</span><span class="p">;</span>
                           <span class="p">}</span>
                     <span class="k">else</span> <span class="nx">executeCallback</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
                       <span class="p">}</span>
                       <span class="nx">req</span><span class="p">.</span><span class="nx">met</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                       <span class="k">if</span> <span class="p">(</span><span class="nx">failsafe</span><span class="o">++</span> <span class="o">&lt;</span> <span class="nx">backtrackMax</span><span class="p">)</span>  <span class="nx">backtrace</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span> 
           <span class="k">else</span> <span class="k">throw</span><span class="p">(</span><span class="s1">&#39;Error: We were in long loop!!!!&#39;</span><span class="p">);</span> 
       <span class="p">}</span> <span class="p">});</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>if we have a leaf, backtrace as far as you can!!!</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">dependency</span><span class="p">.</span><span class="nx">met</span><span class="p">)</span> <span class="p">{</span>
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;Backtracking..&#39;</span><span class="p">);</span>
     <span class="nx">backtrace</span><span class="p">(</span><span class="nx">dependency</span><span class="p">);</span> 
     <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s1">&#39;Backtracking done&#39;</span><span class="p">);</span>
       <span class="p">}</span>
   <span class="p">}</span> 
     </pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <hr />

<p>make the apropriate connections, check for circular dependencies and execute the callbacks</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">finalize</span><span class="p">()</span> <span class="p">{</span>
       <span class="nx">log</span><span class="p">(</span><span class="nx">W</span><span class="p">,</span><span class="s1">&#39;Biggest Exe Order&#39;</span><span class="p">,</span> <span class="nx">biggestExeOrder</span><span class="p">);</span>
       <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s2">&quot;Finished loading, finalizing:&quot;</span><span class="p">);</span>
       <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span>
     <span class="kd">function</span> <span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">dep</span> <span class="o">=</span> <span class="nx">dependencies</span><span class="p">[</span><span class="nx">dep</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>log(D,'def=' , def);</p>             </td>             <td class="code">               <div class="highlight"><pre>         <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="nx">dep</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot; is needed in &quot;</span> <span class="o">+</span>  
             <span class="nx">dep</span><span class="p">.</span><span class="nx">requirers</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">req</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">tag</span> <span class="o">?</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">tag</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);}));</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>def.dependency.requirers.forEach( //array
  function (req) {
    // log(D,'req=', req);
    if ( req.exOrder &lt;  def.exOrder) 
     log(W,"Warning! Cyclic dependency: The objects imported from " + def.id +
         " might be undefined in " + req.id); }); </p>             </td>             <td class="code">               <div class="highlight"><pre>           <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>execute the callbacks</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">executeASAP</span><span class="p">)</span> <span class="nx">onExecute</span><span class="p">(</span><span class="nx">executeLater</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>by default this calls onLoaded_native, but can be reassigned in config</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">onLoaded</span><span class="p">();</span> 
       <span class="p">}</span> 
     </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>all the callbacks gathered during the loading phase get executed now in the right order,
so that their dependencies are all met</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">executeLater</span><span class="p">()</span> <span class="p">{</span>
       
       <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span><span class="s1">&#39;Executing callbacks:&#39;</span><span class="p">);</span>
       <span class="kd">var</span> <span class="nx">sortedDeps</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>sort all definers according to execution order</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span>
     <span class="kd">function</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">dep</span> <span class="o">=</span> <span class="nx">dependencies</span><span class="p">[</span><span class="nx">dep</span><span class="p">];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">dep</span><span class="p">.</span><span class="nx">definer</span> <span class="o">&amp;&amp;</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">requirers</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="nx">sortedDeps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">dep</span><span class="p">);</span>
     <span class="p">});</span>
       <span class="nx">sortedDeps</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span>
     <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">exeOrder</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">exeOrder</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>execute all definers' callbacks, or assign the factory directy to its namespace</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">sortedDeps</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span>
     <span class="kd">function</span> <span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>if (typeof def.factory === 'function') executeCallback(def);</p>             </td>             <td class="code">               <div class="highlight"><pre>         <span class="nx">log</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">exeOrder</span><span class="p">,</span> <span class="nx">dep</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>else getObject(namespace, def.dependency.namespace, def.factory); </p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="p">});</span>
   <span class="p">}</span> 

   <span class="kd">function</span> <span class="nx">executeCallback</span><span class="p">(</span><span class="nx">dep</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">log</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span> <span class="s1">&#39;executing callback: &#39;</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>var self = getObject(namespace, dep.namespace);</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">var</span> <span class="nx">depobjs</span> <span class="o">=</span> <span class="p">[];</span> </pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>all these dependencies should exist in the namespace, they should have been made with
previous calls to this function</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">definer</span><span class="p">.</span><span class="nx">load</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
       <span class="nx">dep</span><span class="p">.</span><span class="nx">dependencies</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">l</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>depobjs.push(getObject(namespace, dep.namespace));</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">depobjs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">value</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> 
         <span class="nx">log</span><span class="p">(</span><span class="nx">W</span><span class="p">,</span><span class="s1">&#39;Warning: injecting undefined (&#39;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;) into &#39;</span> <span class="o">+</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">id</span> <span class="p">);</span> <span class="p">});</span>
       
       <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">definer</span><span class="p">.</span><span class="nx">factory</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">dep</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">depobjs</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">ret</span><span class="p">)</span>  <span class="nx">dep</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">getObject</span><span class="p">(</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">dep</span><span class="p">.</span><span class="nx">namespace</span><span class="p">,</span> <span class="nx">ret</span><span class="p">);</span> </pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>if (ret)  dep.value = ret;
else dep.value = getObject(namespace, dep.namespace, self);
if (namespace) getObject(namespace, dep.namespace, dep.value);</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>pry dependency id apart, this should use regexp
TODO preserve any parameter passing (?a=1&amp;b='bla')
format is: (loader!)(protocol:)url(.ext)(?parameters)(#tag)(|)
TODO regex is: ([a-zA-Z]+!)([a-zA-Z]+:)[a-zA-Z/]+(.[a-zA_Z])(?parameters)(#tag)(|) TOD</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">parseDependencyId</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>var originalId = id;</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="p">)</span> <span class="nx">log</span><span class="p">(</span><span class="nx">W</span><span class="p">,</span><span class="s2">&quot;Empty dependency...&quot;</span><span class="p">);</span>
       <span class="kd">var</span> <span class="nx">blocks</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">loader</span><span class="p">,</span>
       <span class="nx">tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">resource</span><span class="p">,</span> <span class="nx">isAbs</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
       <span class="nx">ns</span><span class="p">,</span> <span class="nx">ext</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <p>the presence of : would suggest an absolute path, as in http://bla.</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="nx">isAbs</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>any id finishing with a | indicates it should block executing of javascript, till
it's loaded and has run itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="nx">id</span><span class="p">[</span><span class="nx">id</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="p">{</span>  <span class="nx">blocks</span>  <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
               <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">id</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>get the tag of the end of the id</p>             </td>             <td class="code">               <div class="highlight"><pre>           <span class="kd">var</span> <span class="nx">lastHash</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">lastHash</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">tag</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">lastHash</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
          <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">lastHash</span><span class="p">);</span>  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>deduce loader from either prefix or .ext
first slice off any extension</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">var</span> <span class="nx">lastDot</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
       <span class="kd">var</span> <span class="nx">lastSlash</span> <span class="o">=</span>  <span class="nx">id</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">lastDot</span><span class="o">&gt;</span><span class="nx">lastSlash</span><span class="p">)</span> <span class="p">{</span> 
     <span class="nx">ext</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">lastDot</span><span class="p">);</span>
     <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span> <span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">lastDot</span><span class="p">);</span> <span class="p">}</span>  </pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>then slice off any pre exclamation mark string</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">var</span> <span class="nx">splitId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">splitId</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="nx">splitId</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;js&#39;</span> <span class="o">||</span> <span class="nx">splitId</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;css&#39;</span> <span class="o">||</span> <span class="nx">splitId</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span>
    <span class="p">)</span> <span class="p">{</span> <span class="nx">loader</span> <span class="o">=</span> <span class="nx">splitId</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>  <span class="p">}</span>
       <span class="k">else</span> <span class="nx">loader</span> <span class="o">=</span> <span class="nx">ext</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>else {if (ext) loader = id.substring(lastDot+1);  }
if neither were present, default to .js for relative paths, data for absolute paths</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">loader</span><span class="p">)</span>  <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isAbs</span><span class="p">)</span> <span class="p">{</span> <span class="nx">loader</span> <span class="o">=</span> <span class="s1">&#39;bootstrap&#39;</span><span class="p">;</span>
             <span class="nx">ext</span> <span class="o">=</span> <span class="s1">&#39;.js&#39;</span><span class="p">;</span>  <span class="p">}</span>
     <span class="k">else</span> <span class="nx">loader</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span><span class="p">;</span>  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>what's left of the id now is used as the namespace for any objects returned by this resource
tag gets added to the namespace if a definer defined in the resource has a tag attr.</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">ns</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">loader</span> <span class="o">===</span> <span class="s1">&#39;data&#39;</span><span class="p">)</span> <span class="nx">ns</span> <span class="o">=</span> <span class="nx">ns</span> <span class="o">+</span> <span class="nx">ext</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>Modify relative urls: </p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isAbs</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>Create url by path substitution </p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="kd">var</span> <span class="nx">firstSlash</span> <span class="o">=</span> <span class="nx">id</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">firstSlash</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">paths</span><span class="p">[</span><span class="nx">id</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">firstSlash</span><span class="p">)];</span>
         <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">+</span> <span class="nx">id</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">firstSlash</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>give url a custom prefix</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">url</span> <span class="o">=</span> <span class="nx">pathPrefix</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="nx">ext</span><span class="p">;</span> 
       <span class="p">}</span>
       <span class="k">else</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">id</span> <span class="o">+</span> <span class="nx">ext</span><span class="p">;</span>
       </pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>return a dependency
the dependency is the same as the resource, except when there are is more than one
definer in a file, multiple dependencies use the same resource then</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">var</span> <span class="nx">resourceId</span> <span class="o">=</span> <span class="nx">loader</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">;</span>
       <span class="kd">var</span> <span class="nx">depId</span> <span class="o">=</span> <span class="nx">resourceId</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">tag</span><span class="p">;</span>
       
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dependencies</span><span class="p">[</span><span class="nx">depId</span><span class="p">])</span> <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>Find or if not existant yet, create resource data structure</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">resources</span><span class="p">[</span><span class="nx">resourceId</span><span class="p">])</span> <span class="p">{</span> <span class="nx">resource</span> <span class="o">=</span> <span class="p">{</span>
         <span class="nx">id</span><span class="o">:</span> <span class="nx">resourceId</span><span class="p">,</span>
         <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span><span class="p">,</span>
         <span class="nx">namespace</span><span class="o">:</span> <span class="nx">ns</span><span class="p">,</span>
         <span class="nx">isAbs</span><span class="o">:</span> <span class="nx">isAbs</span><span class="p">,</span>
         <span class="nx">loader</span><span class="o">:</span> <span class="nx">loader</span><span class="p">,</span>
         <span class="nx">status</span><span class="o">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
         <span class="nx">blocks</span><span class="o">:</span> <span class="nx">blocks</span> <span class="p">};</span>
                 <span class="nx">resources</span><span class="p">[</span><span class="nx">resourceId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">resource</span><span class="p">;</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>this resource has already requested</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="k">else</span> <span class="p">{</span> <span class="nx">resource</span> <span class="o">=</span> <span class="nx">resources</span><span class="p">[</span><span class="nx">loader</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="nx">url</span><span class="p">];</span>
      <span class="nx">resource</span><span class="p">.</span><span class="nx">blocks</span> <span class="o">=</span> <span class="nx">blocks</span><span class="p">;</span> <span class="p">}</span>
     <span class="nx">dependencies</span><span class="p">[</span><span class="nx">depId</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">resource</span><span class="o">:</span> <span class="nx">resource</span><span class="p">,</span>
           <span class="nx">id</span><span class="o">:</span> <span class="nx">depId</span><span class="p">,</span>
           <span class="nx">tag</span><span class="o">:</span> <span class="nx">tag</span><span class="p">,</span>
           <span class="nx">met</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>  
           <span class="nx">namespace</span><span class="o">:</span> <span class="nx">ns</span> <span class="o">+</span> <span class="p">(</span><span class="nx">tag</span> <span class="o">?</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">tag</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
           <span class="nx">dependencies</span><span class="o">:</span> <span class="p">[],</span>
                 <span class="nx">requirers</span><span class="o">:</span> <span class="p">[]</span> <span class="p">};</span> <span class="p">}</span>
       <span class="k">return</span> <span class="nx">dependencies</span><span class="p">[</span><span class="nx">depId</span><span class="p">];</span> <span class="p">}</span> 
     </pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>--------------------------------------events---------------------------------------------
default callback for execute, it just passes on the call</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">onExecute_native</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">();</span> <span class="p">}</span>
     </pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>superfluous.., just some printing out of debug data</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">function</span> <span class="nx">onLoaded_native</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>describe("In bootstrap", function() {
         it("all modules are loaded", function() {
              expect(global.nmodules).toBe(5);
            });
           });  </p>             </td>             <td class="code">               <div class="highlight"><pre>       
       <span class="k">if</span> <span class="p">(</span><span class="nx">testing</span><span class="p">)</span> <span class="nx">execJasmine</span><span class="p">();</span>
       <span class="nx">log</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span><span class="s1">&#39;definers&#39;</span><span class="p">,</span> <span class="nx">definers</span><span class="p">,</span> <span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="nx">dependencies</span><span class="p">,</span><span class="s1">&#39;resources&#39;</span><span class="p">,</span> <span class="nx">resources</span><span class="p">);</span> 
       <span class="nx">log</span><span class="p">(</span><span class="nx">I</span><span class="p">,</span> <span class="s2">&quot;THE END THE END THE END THE END THE END THE END THE END THE END THE END THE END &quot;</span><span class="p">);</span>
       <span class="p">}</span>
     
   <span class="kd">function</span> <span class="nx">execJasmine</span><span class="p">()</span> <span class="p">{</span>
       <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Testing with jasmine&#39;</span><span class="p">);</span>
       <span class="kd">var</span> <span class="nx">jasmineEnv</span> <span class="o">=</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">getEnv</span><span class="p">();</span>
       <span class="nx">jasmineEnv</span><span class="p">.</span><span class="nx">updateInterval</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>

       <span class="cm">/**</span>
<span class="cm">    Create the `HTMLReporter`, which Jasmine calls to provide results of each spec and each suite. The Reporter is responsible for presenting results to the user.</span>
<span class="cm">       */</span>
       <span class="kd">var</span> <span class="nx">htmlReporter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">HtmlReporter</span><span class="p">();</span>
       <span class="nx">jasmineEnv</span><span class="p">.</span><span class="nx">addReporter</span><span class="p">(</span><span class="nx">htmlReporter</span><span class="p">);</span>

       <span class="cm">/**</span>
<span class="cm">    Delegate filtering of specs to the reporter. Allows for clicking on single suites or specs in the results to only run a subset of the suite.</span>
<span class="cm">       */</span>
       <span class="nx">jasmineEnv</span><span class="p">.</span><span class="nx">specFilter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">spec</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">return</span> <span class="nx">htmlReporter</span><span class="p">.</span><span class="nx">specFilter</span><span class="p">(</span><span class="nx">spec</span><span class="p">);</span>
       <span class="p">};</span>

       <span class="cm">/**</span>
<span class="cm">    Run all of the tests when the page finishes loading - and make sure to run any previous `onload` handler</span>

<span class="cm">    ### Test Results</span>

<span class="cm">    Scroll down to see the results of all of these specs.</span>
<span class="cm">       */</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <p>var currentWindowOnload = window.onload;
global.onload = function() {
  if (currentWindowOnload) {
    currentWindowOnload();
  }</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>// document.querySelector('.version').innerHTML = jasmineEnv.versionString();
  execJasmine();
};</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">jasmineEnv</span><span class="p">.</span><span class="nx">execute</span><span class="p">();</span>
   <span class="p">}</span>
     
     </pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>---------------------loaders--------------------------- 
not my code but useful. Might change this to proper AMD plugins.</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="kd">var</span> <span class="nx">loaders</span> <span class="o">=</span> <span class="p">{</span>
       
       <span class="cm">/** MIT License (c) copyright B Cavalier &amp; J Hann */</span>

       <span class="cm">/**</span>
<span class="cm">  * curl text! loader loader</span>
<span class="cm">  *</span>
<span class="cm">  * Licensed under the MIT License at:</span>
<span class="cm">        *   http://www.opensource.org/licenses/mit-license.php</span>
<span class="cm">  */</span>

       <span class="cm">/**</span>
<span class="cm">  * TODO: load xdomain text, too</span>
<span class="cm">  * </span>
<span class="cm">  */</span>

       <span class="nx">data</span> <span class="o">:</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

     <span class="kd">var</span> <span class="nx">progIds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Msxml2.XMLHTTP&#39;</span><span class="p">,</span> <span class="s1">&#39;Microsoft.XMLHTTP&#39;</span><span class="p">,</span> <span class="s1">&#39;Msxml2.XMLHTTP.4.0&#39;</span><span class="p">];</span>

     <span class="kd">function</span> <span class="nx">xhr</span> <span class="p">()</span> <span class="p">{</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">XMLHttpRequest</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>rewrite the getXhr method to always return the native implementation</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">xhr</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span> <span class="p">};</span>
         <span class="p">}</span>
         <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>keep trying progIds until we find the correct one, then rewrite the getXhr method
to always return that one.</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">var</span> <span class="nx">noXhr</span> <span class="o">=</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
           <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;getXhr(): XMLHttpRequest not available&quot;</span><span class="p">);</span>
       <span class="p">};</span>
       <span class="k">while</span> <span class="p">(</span><span class="nx">progIds</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">xhr</span> <span class="o">===</span> <span class="nx">noXhr</span><span class="p">)</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">try</span> <span class="p">{</span>
         <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
         <span class="nx">xhr</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span> <span class="p">};</span>
           <span class="p">}</span>
           <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{}</span>
       <span class="p">}(</span><span class="nx">progIds</span><span class="p">.</span><span class="nx">shift</span><span class="p">()));</span>
         <span class="p">}</span>
         <span class="k">return</span> <span class="nx">xhr</span><span class="p">();</span>
     <span class="p">}</span>

     <span class="kd">function</span> <span class="nx">fetchText</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">errback</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">xhr</span><span class="p">();</span>
         <span class="nx">x</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
         <span class="nx">x</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">status</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">callback</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
           <span class="p">}</span>
           <span class="k">else</span> <span class="p">{</span>
         <span class="nx">errback</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;fetchText() failed. status: &#39;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">.</span><span class="nx">statusText</span><span class="p">));</span>
           <span class="p">}</span>
       <span class="p">}</span>
         <span class="p">};</span>
         <span class="nx">x</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="kd">function</span> <span class="nx">error</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="nx">ex</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="k">return</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <pre><code>'normalize': function (resourceId, toAbsId) {
    // remove options
    return resourceId ? toAbsId(resourceId.split("!")[0]) : resourceId;
},
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>         <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">resourceName</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>remove suffixes (future)
hook up callbacks</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="kd">var</span> <span class="nx">cb</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">resolve</span> <span class="o">||</span> <span class="nx">callback</span><span class="p">,</span>
       <span class="nx">eb</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">reject</span> <span class="o">||</span> <span class="nx">error</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>get the text</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">fetchText</span><span class="p">(</span><span class="nx">req</span><span class="p">[</span><span class="s1">&#39;toUrl&#39;</span><span class="p">](</span><span class="nx">resourceName</span><span class="p">),</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">eb</span><span class="p">);</span>
         <span class="p">},</span>

         <span class="s1">&#39;loader-builder&#39;</span><span class="o">:</span> <span class="s1">&#39;./builder/text&#39;</span>

     <span class="p">};</span>

       <span class="p">})(</span><span class="nx">global</span><span class="p">)</span>
       
       <span class="cm">/** MIT License (c) copyright B Cavalier &amp; J Hann */</span>

       <span class="cm">/**</span>
<span class="cm">  * curl link! loader</span>
<span class="cm">  *</span>
<span class="cm">  * Licensed under the MIT License at:</span>
<span class="cm">  *     http://www.opensource.org/licenses/mit-license.php</span>
<span class="cm">  *</span>
<span class="cm">  */</span>
       <span class="p">,</span><span class="nx">css</span> <span class="o">:</span> <span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
     <span class="cm">/*</span>
<span class="cm">      * curl link! loader</span>
<span class="cm">      * This loader will load css files as &lt;link&gt; elements.  It does not wait for</span>
<span class="cm">      * css file to finish loading / evaluating before executing dependent modules.</span>
<span class="cm">      * This loader also does not handle IE&#39;s 31-stylesheet limit.</span>
<span class="cm">      * If you need any of the above behavior, use curl&#39;s css! loader instead.</span>
<span class="cm">      *</span>
<span class="cm">      * All this loader does is insert &lt;link&gt; elements in a non-blocking manner.</span>
<span class="cm">      *</span>
<span class="cm">      * usage:</span>
<span class="cm">      *     // load myproj/comp.css and myproj/css2.css</span>
<span class="cm">      *      module([&#39;css!myproj/comp,myproj/css2&#39;]);</span>
<span class="cm">      *</span>
<span class="cm">      * Tested in:</span>
<span class="cm">      *      Firefox 1.5, 2.0, 3.0, 3.5, 3.6, and 4.0b6</span>
<span class="cm">      *      Safari 3.0.4, 3.2.1, 5.0</span>
<span class="cm">      *      Chrome 7+</span>
<span class="cm">      *      Opera 9.52, 10.63, and Opera 11.00</span>
<span class="cm">      *      IE 6, 7, and 8</span>
<span class="cm">      *      Netscape 7.2 (WTF? SRSLY!)</span>
<span class="cm">      * Does not work in Safari 2.x :(</span>
<span class="cm">      */</span>


     <span class="kd">var</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>compressibility shortcuts</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">createElement</span> <span class="o">=</span> <span class="s1">&#39;createElement&#39;</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>doc will be undefined during a build</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">doc</span> <span class="o">=</span> <span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <p>regexp to find url protocol for IE7/8 fix (see fixProtocol)</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">isProtocolRelativeRx</span> <span class="o">=</span> <span class="sr">/^\/\//</span><span class="p">,</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>find the head element and set it to it's standard property if nec.</p>             </td>             <td class="code">               <div class="highlight"><pre>     <span class="nx">head</span><span class="p">;</span>

     <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">head</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">head</span> <span class="o">||</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">head</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>
     <span class="p">}</span>

     <span class="kd">function</span> <span class="nx">nameWithExt</span> <span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">defaultExt</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">return</span> <span class="nx">name</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="o">?</span>
       <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nx">defaultExt</span> <span class="o">:</span> <span class="nx">name</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="kd">function</span> <span class="nx">createLink</span> <span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">href</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">[</span><span class="nx">createElement</span><span class="p">](</span><span class="s1">&#39;link&#39;</span><span class="p">);</span>
         <span class="nx">link</span><span class="p">.</span><span class="nx">rel</span> <span class="o">=</span> <span class="s2">&quot;stylesheet&quot;</span><span class="p">;</span>
         <span class="nx">link</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;text/css&quot;</span><span class="p">;</span>
         <span class="nx">link</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">href</span><span class="p">;</span>
         <span class="k">return</span> <span class="nx">link</span><span class="p">;</span>
     <span class="p">}</span>

     <span class="kd">function</span> <span class="nx">fixProtocol</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">protocol</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>IE 7 &amp; 8 can't handle protocol-relative urls:
http://www.stevesouders.com/blog/2010/02/10/5a-missing-schema-double-download/</p>             </td>             <td class="code">               <div class="highlight"><pre>         <span class="k">return</span> <span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">isProtocolRelativeRx</span><span class="p">,</span> <span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span><span class="p">);</span>
     <span class="p">}</span>

     <span class="k">return</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <pre><code>'normalize': function (resourceId, toAbsId) {
    // remove options
    return resourceId ? toAbsId(resourceId.split("!")[0]) : resourceId;
},
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>         <span class="s1">&#39;load&#39;</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">resourceId</span><span class="p">,</span> <span class="nx">require</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">link</span><span class="p">,</span> <span class="nx">fix</span><span class="p">;</span>

       <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">[</span><span class="s1">&#39;toUrl&#39;</span><span class="p">](</span><span class="nx">nameWithExt</span><span class="p">(</span><span class="nx">resourceId</span><span class="p">,</span> <span class="s1">&#39;css&#39;</span><span class="p">));</span>
       <span class="nx">fix</span> <span class="o">=</span> <span class="s1">&#39;fixSchemalessUrls&#39;</span> <span class="k">in</span> <span class="nx">config</span> <span class="o">?</span> <span class="nx">config</span><span class="p">[</span><span class="s1">&#39;fixSchemalessUrls&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span>
       <span class="nx">url</span> <span class="o">=</span> <span class="nx">fix</span> <span class="o">?</span> <span class="nx">fixProtocol</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">fix</span><span class="p">)</span> <span class="o">:</span> <span class="nx">url</span><span class="p">;</span>
       <span class="nx">link</span> <span class="o">=</span> <span class="nx">createLink</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
         
       <span class="nx">head</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">link</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>link does not have a onload, so create a fake one.. Our code needs real async callbacks,
not a synchronous timeline. This function needs to return immediately and create an
fake event for the onload of css, loaded or not...</p>             </td>             <td class="code">               <div class="highlight"><pre>       <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> </pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>callback(link.sheet || link.styleSheet);</p>             </td>             <td class="code">               <div class="highlight"><pre>           <span class="nx">callback</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
       <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

         <span class="p">}</span>

     <span class="p">};</span>

       <span class="p">})(</span><span class="nx">global</span><span class="p">)</span>
   <span class="p">};</span>  </pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>executing code:</p>             </td>             <td class="code">               <div class="highlight"><pre>   <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">bootstrap</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="nx">init</span><span class="p">(</span><span class="nx">bootstrap</span><span class="p">);</span>
   <span class="k">else</span> <span class="nx">init</span><span class="p">(</span><span class="nx">default_config</span><span class="p">);</span>
 <span class="p">})(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p><!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <div class="css_load_catcher"></div>
        <div class="css_load_time"></div>
    </body>
</html>

<!DOCTYPE html>
<html>
    <head>
    </head>
    <body>
        <div class="css_load_catcher"></div>
        <div class="css_load_time"></div>
    </body>
</html>
</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>InnerCallback = function(link, callback)
{
    $('.css<em>load</em>time').html((new Date().getTime() - link._loadStart) + 'ms');
    callback(link);
}</p>             </td>             <td class="code">               <div class="highlight"><pre>            </pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>LoadCss = function(url, callback)
{
    var link = document.createElement('link');</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <pre><code>link.rel   = 'stylesheet';
link.type  = 'text/css';
link.href  = url;
link._rawUrl = url;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>                </pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <pre><code>if ($.browser.msie || $.browser.opera)
{
    link.onload = function()
    {
        InnerCallback(link, callback);
    }
}
else if ($.browser.mozilla)
{
    $('.css_load_catcher').bind('animationstart', function()
    {
        InnerCallback(link, callback);
    });
}
else if ($.browser.webkit)
{
    $('.css_load_catcher').bind('webkitAnimationStart', function()
    {
        InnerCallback(link, callback);
    });                
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>                </pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <pre><code>link._loadStart = new Date().getTime();
$('head')[0].appendChild(link);                
</code></pre>

<p>}</p>             </td>             <td class="code">               <div class="highlight"><pre>            </pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>$(document).ready(function()
{
    LoadCss('https://dl.dropbox.com/s/hzot90l848gihof/css<em>load</em>test.css?dl=1', function(link)
    {
        console.log(link, ' successefully loaded');
    });
});</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 