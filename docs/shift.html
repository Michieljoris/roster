<!DOCTYPE html>  <html> <head>   <title>shift.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="calculateTimesheet.html">                 calculateTimesheet.js               </a>                                           <a class="source" href="calculateTimesheetColumn.html">                 calculateTimesheetColumn.js               </a>                                           <a class="source" href="calendar.html">                 calendar.js               </a>                                           <a class="source" href="editorLoader.html">                 editorLoader.js               </a>                                           <a class="source" href="editorManager.html">                 editorManager.js               </a>                                           <a class="source" href="editorUtils.html">                 editorUtils.js               </a>                                           <a class="source" href="fetchTimesheetShifts.html">                 fetchTimesheetShifts.js               </a>                                           <a class="source" href="globals.html">                 globals.js               </a>                                           <a class="source" href="layout.html">                 layout.js               </a>                                           <a class="source" href="locationEditor.html">                 locationEditor.js               </a>                                           <a class="source" href="main.html">                 main.js               </a>                                           <a class="source" href="parentListEditor.html">                 parentListEditor.js               </a>                                           <a class="source" href="personEditor.html">                 personEditor.js               </a>                                           <a class="source" href="pouchDS.html">                 pouchDS.js               </a>                                           <a class="source" href="quickpouch.html">                 quickpouch.js               </a>                                           <a class="source" href="shift.html">                 shift.js               </a>                                           <a class="source" href="shiftEditor.html">                 shiftEditor.js               </a>                                           <a class="source" href="shiftQualifier.html">                 shiftQualifier.js               </a>                                           <a class="source" href="table.html">                 table.js               </a>                                           <a class="source" href="tableFilter.html">                 tableFilter.js               </a>                                           <a class="source" href="test.html">                 test.js               </a>                                           <a class="source" href="testdata.html">                 testdata.js               </a>                                           <a class="source" href="timesheet.html">                 timesheet.js               </a>                                           <a class="source" href="timesheet_canvas.html">                 timesheet_canvas.js               </a>                                           <a class="source" href="typesAndFields.html">                 typesAndFields.js               </a>                                           <a class="source" href="viewTree.html">                 viewTree.js               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               shift.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/*global VOW:false logger:false isc:false define:false */</span>
<span class="cm">/*jshint strict:true unused:true smarttabs:true eqeqeq:true immed: true undef:true*/</span>
<span class="cm">/*jshint maxparams:5 maxcomplexity:7 maxlen:190 devel:true*/</span>

<span class="nx">define</span>
<span class="p">({</span> 
    <span class="nx">inject</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;shiftQualifier&#39;</span><span class="p">,</span> <span class="s1">&#39;typesAndFields&#39;</span><span class="p">,</span> <span class="s1">&#39;globals&#39;</span><span class="p">],</span>
    <span class="nx">factory</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">shiftQualifier</span><span class="p">,</span> <span class="nx">typesAndFields</span><span class="p">,</span> <span class="nx">globals</span><span class="p">)</span>
    <span class="p">{</span> <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>
      
      <span class="kd">var</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">logger</span><span class="p">(</span><span class="s1">&#39;shift&#39;</span><span class="p">);</span>
      </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>var person, location, fortnight;</p>             </td>             <td class="code">               <div class="highlight"><pre>      
      </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>function getDoc(record) {
    if (record._id) return VOW.kept(record);
    var vow = VOW.make();
    globals.db.get(record, function(err, doc) {
        log.d('getting doc',doc, err);
        if (!err) {
            vow.keep(doc); <br />
            log.d('keeping vow');
        }
        else {
            err.record = record; 
            vow<a href="err">'break'</a>; <br />
            log.d('breaking vow');
        }
    });
    vow.promise.test =record;
    return vow.promise;
}</p>             </td>             <td class="code">               <div class="highlight"><pre>      </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>function go(person, location, fortnight) {</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <pre><code>VOW.every([
    getDoc(person),
    getDoc(location)
]).when(
    processData,
    function (msg) {
        log.d('ERROR: could not get some of the data needed to create this shift', msg);
    }
);
</code></pre>

<p>}</p>             </td>             <td class="code">               <div class="highlight"><pre>      </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>function processData(data) {
    //person, location and shifts should be set now
    log.d('-----------------');
    log.d(data.person, data.location, data.shifts);
    log.d('-----------------');
}</p>             </td>             <td class="code">               <div class="highlight"><pre>      </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>returns length between 2 dates in hours</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="kd">function</span> <span class="nx">calculateLength</span><span class="p">(</span><span class="nx">period</span><span class="p">)</span> <span class="p">{</span>
          
          <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">period</span><span class="p">.</span><span class="nx">startDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">end</span> <span class="o">=</span> <span class="nx">period</span><span class="p">.</span><span class="nx">endDate</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span>
          <span class="kd">var</span> <span class="nx">minutes</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span> <span class="p">(</span><span class="nx">end</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60000</span> <span class="p">);</span>
          <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">minutes</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">minutes</span><span class="o">%</span><span class="mi">60</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">;</span>
          
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">create</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">startDate</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">today</span><span class="p">().</span><span class="nx">set</span><span class="p">({</span>
              <span class="nx">hour</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">startTime</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span>
              <span class="nx">minute</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">startTime</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span>
              <span class="nx">second</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="nx">year</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span>
              <span class="nx">month</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(),</span>
              <span class="nx">day</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span>
          <span class="p">});</span>
          <span class="kd">var</span> <span class="nx">endDate</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">today</span><span class="p">().</span><span class="nx">set</span><span class="p">({</span>
              <span class="nx">hour</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">endTime</span><span class="p">.</span><span class="nx">getHours</span><span class="p">(),</span>
              <span class="nx">minute</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">endTime</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">(),</span>
              <span class="nx">second</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
              <span class="nx">year</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getYear</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">,</span>
              <span class="nx">month</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(),</span>
              <span class="nx">day</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span>
          <span class="p">});</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">endTime</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
              <span class="nx">values</span><span class="p">.</span><span class="nx">endTime</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">()</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">endDate</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">endDate</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
          
          
          <span class="kd">var</span> <span class="nx">shift</span> <span class="o">=</span> <span class="p">{</span>
              <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;shift&#39;</span><span class="p">,</span>
              <span class="nx">_id</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">_id</span><span class="p">,</span>
              <span class="nx">_rev</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">_rev</span><span class="p">,</span>
              <span class="nx">person</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">person</span><span class="p">,</span> <span class="c1">//array of _id&#39;s of people doing the shift</span>
              <span class="nx">personstring</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">person</span> <span class="o">&amp;&amp;</span>
                  <span class="nx">values</span><span class="p">.</span><span class="nx">person</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="c1">//for search by human names</span>
              <span class="nx">personNames</span> <span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">personNames</span> <span class="o">&amp;&amp;</span>
                  <span class="nx">values</span><span class="p">.</span><span class="nx">personNames</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="c1">//for search by doc _id</span>
              <span class="nx">location</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
              <span class="nx">locationNames</span> <span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">locationNames</span> <span class="o">&amp;&amp;</span>
                  <span class="nx">values</span><span class="p">.</span><span class="nx">locationNames</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
              <span class="nx">startDate</span><span class="o">:</span> <span class="nx">startDate</span><span class="p">,</span>
              <span class="nx">endDate</span><span class="o">:</span> <span class="nx">endDate</span><span class="p">,</span>
              <span class="nx">date</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">date</span><span class="p">,</span>
              <span class="nx">startTime</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">startTime</span><span class="p">,</span>
              <span class="nx">endTime</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">endTime</span><span class="p">,</span>
              <span class="nx">claim</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">claim</span><span class="p">,</span>
              <span class="nx">repeats</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">repeats</span><span class="p">,</span> <span class="c1">//TODO not implemented yet </span>
              <span class="nx">notes</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">notes</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
              <span class="nx">endTijd</span><span class="o">:</span> <span class="s1">&#39;- &#39;</span> <span class="o">+</span> <span class="nx">isc</span><span class="p">.</span><span class="nx">Time</span><span class="p">.</span><span class="nx">toTime</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">endDate</span><span class="p">,</span> <span class="s1">&#39;toShortPaddedTime&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">),</span>
              <span class="nx">description</span><span class="o">:</span> <span class="nx">values</span><span class="p">.</span><span class="nx">personNames</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">personNames</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;&lt;p&gt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">notes</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
          <span class="p">};</span>
          <span class="nx">shift</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">calculateLength</span><span class="p">(</span><span class="nx">shift</span><span class="p">);</span>
          </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>set claim fields TODO replace with switch</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">claim</span> <span class="o">===</span> <span class="s1">&#39;Event&#39;</span><span class="p">)</span> <span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">claim</span> <span class="o">===</span> <span class="s1">&#39;Away from base&#39;</span><span class="p">)</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">awayFromBase</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
          <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">claim</span> <span class="o">===</span> <span class="s1">&#39;Normal shift&#39;</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">isc</span><span class="p">.</span><span class="nx">addProperties</span><span class="p">(</span><span class="nx">shift</span><span class="p">,</span> <span class="nx">shiftQualifier</span><span class="p">.</span><span class="nx">getWorkHourFields</span><span class="p">(</span><span class="nx">shift</span><span class="p">));</span>    
              <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">publicHoliday</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">isPublicHolidayWorked</span><span class="p">)</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">publicHolidayWorked</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">publicHoliday</span><span class="p">;</span>
                  <span class="k">else</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">publicHolidayNotWorked</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">publicHoliday</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>
          
          <span class="k">else</span> <span class="nx">shift</span><span class="p">[</span><span class="nx">typesAndFields</span><span class="p">.</span><span class="nx">getFieldNameByTitle</span><span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">claim</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
          
          <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span><span class="p">.</span><span class="nx">adminHoursUsed</span><span class="p">)</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">ord</span> <span class="o">=</span> <span class="nx">shift</span><span class="p">.</span><span class="nx">adminHoursUsed</span><span class="p">;</span> <span class="c1">//TODO proper implementation</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>at the moment a shift is a complete admin shift. Otherwise
make a separate field for the adminhours used in the UI
editor and make sure it is less than length of the shift</p>             </td>             <td class="code">               <div class="highlight"><pre>          </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>check for limits and rules and policies..  min length of
shift, max length of shift, max overtime, working during
sleepover time, but it's not disturbed sleep etc
if it's an error return it as such so that the editor has
a chance to cancel the save</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">return</span> <span class="nx">shift</span><span class="p">;</span>
          
      <span class="p">}</span>
   </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>//date, time, text, integer, boolean
function getDay(number) { // 0&lt;=number&lt;14</p>             </td>             <td class="code">               <div class="highlight"><pre>          </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>}</p>             </td>             <td class="code">               <div class="highlight"><pre>      
      <span class="k">return</span> <span class="p">{</span>
          <span class="nx">create</span><span class="o">:</span> <span class="nx">create</span>
      <span class="p">};</span>
   
    <span class="p">}});</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 